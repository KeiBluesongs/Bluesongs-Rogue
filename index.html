<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Bluesongs Rogue (Offline)</title>
  <style>
:root{
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
  --bg:#0e0f12; --panel:#12141a; --panel2:#1a1c22; --border:#2a2d37; --text:#e8e8e8;
  --gap:10px;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  overscroll-behavior:none;
  /* safe area padding */
  padding:
    calc(12px + env(safe-area-inset-top, 0px))
    calc(16px + env(safe-area-inset-right, 0px))
    calc(16px + env(safe-area-inset-bottom, 0px))
    calc(16px + env(safe-area-inset-left, 0px));
}
h1{ margin:0 0 4px; font-size:18px; font-weight:700; letter-spacing:.2px; }

#wrap{
  max-width:980px;
  margin:0 auto;
  height:100%;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}

#hud{
  display:grid;
  grid-template-columns:auto auto auto 1fr;
  gap:10px;
  align-items:center;
  margin:10px 0 8px;
}
.pill{
  padding:6px 10px;
  border-radius:999px;
  background:var(--panel2);
  border:1px solid var(--border);
  font-size:13px;
}
#statSeed{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

details#logDetails{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px;
  max-width:100%;
  overflow:hidden; /* never spill over the game area */
}
#logDetails > summary{
  list-style:none;
  cursor:pointer;
  user-select:none;
  font-size:12px;
  opacity:.85;
}
#logDetails > summary::-webkit-details-marker{ display:none; }
#logDetails > summary::before{ content:"▶ "; }
#logDetails[open] > summary::before{ content:"▼ "; }

#log{
  margin:6px 0 0;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.04);
  font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  font-size:14px;
  line-height:1.35;
  overflow:hidden;
  display:-webkit-box;
  -webkit-box-orient:vertical;
  -webkit-line-clamp:2; /* collapsed: show up to 2 lines */
}
#log > div{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
details[open] #log{
  display:block;
  -webkit-line-clamp:unset;
  overflow:auto;
  max-height:min(22svh, 240px);
}

#logDetails[open] #log{
  max-height:min(22svh, 240px);
  overflow:auto;
}

#game{
  flex:1;
  min-height:0;
  display:flex;
  flex-direction:column;
  gap:var(--gap);
}
#canvasWrap{
  flex:1;
  min-height:0;
  display:flex;
  align-items:center;
  justify-content:flex-end; /* push canvas down for thumb reach */
  flex-direction:column;
}
canvas{
  width:100%;
  height:auto;
  aspect-ratio:1/1;
  background:#0b0c10;
  border:1px solid var(--border);
  border-radius:10px;
  touch-action:none; /* we handle swipe/pinch ourselves */
  max-width:620px;
  max-height:58svh;
}

#panel{
  flex:0 0 auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.row{ display:flex; flex-wrap:wrap; gap:8px; }
button{
  background:#1e2230;
  color:#fff;
  border:1px solid #3a3f50;
  border-radius:10px;
  padding:10px 12px;
  font-size:14px;
}
button:active{ transform:translateY(1px); }

#helpToggle{
  font-size:12px;
  opacity:.8;
  padding:0 2px;
}
#helpDetails{
  background:transparent;
  border:none;
  padding:0;
}
#helpDetails summary{ list-style:none; cursor:pointer; user-select:none; }
#helpDetails summary::-webkit-details-marker{ display:none; }
#helpBox{
  margin-top:6px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 12px;
  font-size:13px;
  line-height:1.35;
}

@media (max-width: 859px){
  body{ height:100svh; overflow:hidden; }
  h1{ font-size:20px; }
  /* lock one screen */
  #wrap{ height:100%; }
  /* keep HUD in one row: 3 small + seed flexible */
  #hud{
    display:grid;
    grid-template-columns:auto auto auto 1fr;
    gap:8px;
    align-items:center;
  }
  .pill{ font-size:13px; padding:7px 10px; }
  #statSeed{ min-width:0; }
  canvas{ max-height:52svh; }
  #log{ max-height:2.75em; } /* slightly shorter on mobile */
  #logDetails[open] #log{ max-height:18svh; }

  /* --- iPhone/Small screen: lock viewport, respect safe areas, avoid scroll --- */
  body{
    position:fixed;
    inset:0;
    overflow:hidden;
  }
  #wrap{
    height:100%;
    padding:calc(env(safe-area-inset-top) + 10px)
            calc(env(safe-area-inset-right) + 12px)
            calc(env(safe-area-inset-bottom) + 14px)
            calc(env(safe-area-inset-left) + 12px);
    box-sizing:border-box;
    overflow:hidden;
  }
  /* Swipe is primary on iPhone; hide D-pad to free space */
  #dpad{ display:none !important; }
  /* Make HUD pills a bit tighter so SEED fits on same row */
  .pill{ padding:10px 12px; font-size:13px; }
  #statSeed{ font-size:12px; padding:10px 12px; }
}

details#codeDetails{
  background:transparent;
  border:none;
  padding:0;
}
#codeDetails summary.hint{
  list-style:none;
  cursor:pointer;
  user-select:none;
  font-size:12px;
  opacity:.85;
  padding:0 2px; /* keep away from rounded corners */
}
#codeDetails summary.hint::-webkit-details-marker{ display:none; }
#codeDetails .hint{ padding:0 2px; }
#codeBox{
  width:100%;
  min-height:78px;
  resize:none;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  padding:10px 12px;
  color:var(--text);
  font-size:13px;
  line-height:1.35;
}
</style>
</head>
<body>
  <div id="wrap">
    <h1>Bluesongs Rogue</h1>
    <div id="hud">
      <div class="pill" id="statFloor">FLOOR: 1</div>
      <div class="pill" id="statHP">HP: 10/10</div>
      <div class="pill" id="statATK">ATK: 2</div>
      <div class="pill" id="statSeed">SEED: -</div>
    </div>

    <details id="logDetails">
      <summary id="logSummary">ログ（タップで開く）</summary>
      <div id="log"></div>
    </details>

    <div id="game">
      <div id="canvasWrap">
        <canvas id="cv" width="620" height="620" aria-label="game"></canvas>
      </div>

      <div id="panel">
        <div class="row">
          <button id="btnNew">New Run</button>
          <button id="btnNext">Next Floor</button>
          <button id="btnSave">Save</button>
          <button id="btnLoad">Load</button>
        </div>

        <div class="row">
          <button id="btnExport">Export Code</button>
          <button id="btnImport">Import Code</button>
          <button id="btnHelp">Help</button>
        </div>

        <div id="dpad" aria-label="dpad">
          <div class="empty">.</div><button data-move="U">▲</button><div class="empty">.</div>
          <button data-move="L">◀</button><button data-move="W">●</button><button data-move="R">▶</button>
          <div class="empty">.</div><button data-move="D">▼</button><div class="empty">.</div>
        </div>
        <details id="codeDetails">
          <summary class="hint">操作ヘルプ / Export・Import（タップで開く）</summary>
          <div class="hint" style="margin-top:8px;">
            PC: 矢印/WASDで移動、Spaceで攻撃、Nで次階。<br/>
            iPhone: <b>スワイプ</b>で移動、<b>タップ</b>で待機(ターン進行)、<b>ピンチ</b>でズーム。
          </div>
          <textarea id="codeBox" placeholder="Export/Import code がここに出ます"></textarea>
        </details>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Utilities (seeded RNG) =====
  function xmur3(str){
    let h = 1779033703 ^ str.length;
    for (let i=0; i<str.length; i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h << 13) | (h >>> 19);
    }
    return function(){
      h = Math.imul(h ^ (h >>> 16), 2246822507);
      h = Math.imul(h ^ (h >>> 13), 3266489909);
      h ^= (h >>> 16);
      return h >>> 0;
    };
  }
  function sfc32(a,b,c,d){
    return function(){
      a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
      let t = (a + b) | 0;
      a = b ^ (b >>> 9);
      b = (c + (c << 3)) | 0;
      c = (c << 21) | (c >>> 11);
      d = (d + 1) | 0;
      t = (t + d) | 0;
      c = (c + t) | 0;
      return (t >>> 0) / 4294967296;
    }
  }
  function makeRng(seedStr){
    const seed = xmur3(seedStr);
    return sfc32(seed(), seed(), seed(), seed());
  }
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const randInt=(rng, n)=>Math.floor(rng()*n);

  // ===== Game constants =====
  const W = 31, H = 31;
  const canvas = document.getElementById('cv');
  const ctx = canvas.getContext('2d');

  // Zoom (pinch on iPhone). 1.0 = whole map fits; >1 zooms in.
  const IS_MOBILE = matchMedia("(max-width: 859px)").matches;
  let zoom = IS_MOBILE ? 1.6 : 1.0;
  const ZOOM_MIN = 0.9;
  const ZOOM_MAX = 2.8;

  const ui = {
    floor: document.getElementById('statFloor'),
    hp: document.getElementById('statHP'),
    atk: document.getElementById('statATK'),
    seed: document.getElementById('statSeed'),
    log: document.getElementById('log'),
    code: document.getElementById('codeBox'),
    codeDetails: document.getElementById('codeDetails'),
  };

  function log(msg){
  const line = document.createElement("div");
  line.textContent = msg;
  ui.log.appendChild(line);
  // keep newest visible
  ui.log.scrollTop = ui.log.scrollHeight;
}


  // ===== Save/Load =====
  const LS_KEY = "miniRogueSaveV1";

  function saveLocal(){
    if (!state) return;
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    log("Saved to this browser.");
  }

  function loadLocal(){
    const raw = localStorage.getItem(LS_KEY);
    if (!raw){
      log("No save found in this browser.");
      return;
    }
    try{
      const obj = JSON.parse(raw);
      if (!obj || obj.version !== 1) throw new Error("bad save");
      state = obj;
      log("Loaded from this browser.");
      updateHud();
      render();
    } catch(e){
      log("Load failed (corrupted save).");
    }
  }

  // ===== Export/Import Code (copy/paste sync) =====
  // Simple base64 encode/decode for UTF-8
  function b64encode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    for (const b of bytes) bin += String.fromCharCode(b);
    return btoa(bin);
  }
  function b64decode(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array([...bin].map(ch=>ch.charCodeAt(0)));
    return new TextDecoder().decode(bytes);
  }

  function exportCode(){
    if (!state) return;
    // We export minimal necessary state
    const payload = {
      v: 1,
      seed: state.seed,
      floor: state.floor,
      player: state.player,
      enemies: state.enemies,
      map: state.map,
      revealed: state.revealed,
      exit: state.exit,
      turn: state.turn,
    };
    const json = JSON.stringify(payload);
    const code = b64encode(json);
    if (ui.codeDetails) ui.codeDetails.open = true;
    ui.code.value = code;
    ui.code.focus();
    ui.code.select();
    log("Exported code (copied if you paste it somewhere).");
  }

  function importCode(){
    if (ui.codeDetails) ui.codeDetails.open = true;
    const code = ui.code.value.trim();
    if (!code){
      log("Paste code into the box first.");
      return;
    }
    try{
      const json = b64decode(code);
      const payload = JSON.parse(json);
      if (!payload || payload.v !== 1) throw new Error("bad");
      state = {
        version: 1,
        seed: payload.seed,
        floor: payload.floor,
        player: payload.player,
        enemies: payload.enemies,
        map: payload.map,
        revealed: payload.revealed,
        exit: payload.exit,
        turn: payload.turn,
      };
      log("Imported code successfully.");
      updateHud();
      render();
    } catch(e){
      log("Import failed (invalid code).");
    }
  }

  function nextFloor(){
    if (!state) return;
    // allow only if at exit
    if (state.player.x!==state.exit.x || state.player.y!==state.exit.y){
      log("You are not on the exit yet (⏚).");
      return;
    }
    // small reward
    state.player.hp = Math.min(state.player.maxHp, state.player.hp + 2);
    state.floor += 1;
    buildFloor();
    render();
  }

  // ===== Input handling =====
  function keyHandler(ev){
    if (!state) return;
    if (ev.key === "ArrowUp" || ev.key.toLowerCase()==="w") { ev.preventDefault(); tryMove(0,-1); }
    else if (ev.key === "ArrowDown" || ev.key.toLowerCase()==="s") { ev.preventDefault(); tryMove(0,1); }
    else if (ev.key === "ArrowLeft" || ev.key.toLowerCase()==="a") { ev.preventDefault(); tryMove(-1,0); }
    else if (ev.key === "ArrowRight" || ev.key.toLowerCase()==="d") { ev.preventDefault(); tryMove(1,0); }
    else if (ev.key === " "){ ev.preventDefault(); // attack in place = wait, but if adjacent enemy? keep simple
      // Try attack any adjacent enemy (priority order)
      const dirs = [[0,-1],[0,1],[-1,0],[1,0]];
      for (const [dx,dy] of dirs){
        const e = enemyAt(state.player.x+dx, state.player.y+dy);
        if (e){ attackEnemy(e); endTurn(); return; }
      }
      log("No adjacent enemy. (Space does nothing)");
    }
    else if (ev.key.toLowerCase()==="n"){ ev.preventDefault(); nextFloor(); }
  }

  document.addEventListener('keydown', keyHandler, {passive:false});

  // Prevent iOS double-tap zoom in the app
  document.addEventListener('dblclick', (e)=>{ e.preventDefault(); }, {passive:false});

  // iPhone-friendly controls: swipe to move, tap to wait (on the map)
  let touchStart = null;
  let pinchStartDist = null;
  let pinchStartZoom = null;
  const dist2 = (t1,t2)=>Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY);
  canvas.addEventListener('touchstart', (e)=>{
    if (!state) return;

    // Pinch start
    if (e.touches.length === 2){
      pinchStartDist = dist2(e.touches[0], e.touches[1]);
      pinchStartZoom = zoom;
      touchStart = null;
      e.preventDefault();
      return;
    }

    // Swipe/tap start
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    touchStart = { x: t.clientX, y: t.clientY };
    e.preventDefault();
  }, {passive:false});

  // Pinch move (zoom)
  canvas.addEventListener('touchmove', (e)=>{
    if (!state) return;
    if (e.touches.length === 2 && pinchStartDist){
      const d = dist2(e.touches[0], e.touches[1]);
      const ratio = d / pinchStartDist;
      zoom = clamp(pinchStartZoom * ratio, ZOOM_MIN, ZOOM_MAX);
      render();
      e.preventDefault();
    }
  }, {passive:false});

  canvas.addEventListener('touchend', (e)=>{
    if (!state) return;

    // End pinch
    if (pinchStartDist && e.touches.length < 2){
      pinchStartDist = null;
      pinchStartZoom = null;
    }

    // If pinch was active, don't treat as swipe/tap
    if (!touchStart) return;

    const t = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : null;
    if (!t) return;
    const dx = t.clientX - touchStart.x;
    const dy = t.clientY - touchStart.y;
    touchStart = null;

    const ax = Math.abs(dx), ay = Math.abs(dy);
    const SWIPE = 28;   // px
    const TAP = 10;     // px

    if (ax < TAP && ay < TAP){
      // tap = wait
      waitTurn();
      e.preventDefault();
      return;
    }

    if (ax < SWIPE && ay < SWIPE){
      // tiny gesture: ignore
      e.preventDefault();
      return;
    }

    if (ax >= ay){
      if (dx > 0) tryMove(1,0); else tryMove(-1,0);
    } else {
      if (dy > 0) tryMove(0,1); else tryMove(0,-1);
    }
    e.preventDefault();
  }, {passive:false});


  // D-pad buttons (touch-friendly)
  document.querySelectorAll('#dpad button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const m = btn.dataset.move;
      if (m==="U") tryMove(0,-1);
      else if (m==="D") tryMove(0,1);
      else if (m==="L") tryMove(-1,0);
      else if (m==="R") tryMove(1,0);
      else if (m==="W") waitTurn();
    });
  });

  // Buttons
  document.getElementById('btnNew').addEventListener('click', ()=> newRun());
  document.getElementById('btnNext').addEventListener('click', nextFloor);
  document.getElementById('btnSave').addEventListener('click', saveLocal);
  document.getElementById('btnLoad').addEventListener('click', loadLocal);
  document.getElementById('btnExport').addEventListener('click', exportCode);
  document.getElementById('btnImport').addEventListener('click', importCode);
  document.getElementById('btnHelp').addEventListener('click', ()=>{
    log("Goal: explore, survive, reach exit ⏚.");
    log("Move into enemies to attack. Enemies adjacent will hit you on their turn.");
    log("Export/Import code = copy/paste sync between iPhone and iMac.");
  });

  // Start
  newRun();
})();
</script>
</body>
</html>